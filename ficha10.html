<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ficha | IDGoNow</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      padding: 1rem;
      max-width: 500px;
      margin: auto;
    }
    .logo {
      text-align: center;
    }
    .logo img {
      width: 140px;
      margin-bottom: 1rem;
    }
    h2 {
      text-align: center;
      margin: 0.5rem 0;
    }
    .foto-circular {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      border: 4px solid #eee;
      display: block;
      margin: 1rem auto;
    }
    .info-central {
      background: #eee;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1.2rem;
    }
    .info-central p {
      margin: 0.3rem 0;
      font-size: 15px;
    }
    .seccion-contacto {
      background: #007b8f;
      color: white;
      padding: 0.7rem 1rem;
      border-radius: 12px 12px 0 0;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .seccion-contacto::before { content: '📇'; }
    .datos-contacto {
      border: 1px solid #007b8f;
      border-top: none;
      border-radius: 0 0 12px 12px;
      padding: 1rem;
      font-size: 15px;
    }
    .datos-contacto p { margin: 0.3rem 0; }
    .btns {
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
      margin-top: 1rem;
    }
    .btns a {
      text-decoration: none;
      padding: 1rem;
      border-radius: 12px;
      font-weight: bold;
      text-align: center;
      font-size: 16px;
      color: white;
    }
    .call { background: #1a73e8; }
    .whatsapp { background: #25d366; }
    .ubicacion { background: #fbbc05; color: #222; }

    #ubicacionModal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #0008;
      z-index: 999;
      align-items: center;
      justify-content: center;
    }
    #ubicacionModal .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 12px;
      max-width: 90%;
      width: 400px;
      text-align: center;
    }
    #ubicacionModal iframe {
      border: 0;
      border-radius: 8px;
      width: 100%;
      height: 250px;
    }
    #ubicacionModal button {
      padding: 0.7rem 1rem;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #ubicacionModal .confirm { background: #25d366; color: white; }
    #ubicacionModal .cancel { background: #ccc; margin-left: 1rem; }
  </style>
</head>
<script>
  const params = new URLSearchParams(window.location.search);
  const recordId = params.get("id");
  const API_URL = `https://idgonow.up.railway.app/api/v2/tables/m1ebsgkhbspdiqq/records/${recordId}`;
  const API_TOKEN = "HzyX5A2ycuqlDhV2uyiQ-12UhN_DM0uO4Bfxe7hy";

  let ubicacionActual = { lat: null, lng: null, tel: null, nombre: null };

  fetch(API_URL, { headers: { "xc-token": API_TOKEN } })
  .then(res => res.json())
  .then(data => {
    const row = data.fields || data;
    const saludo = row["Nombre"] ? "Hola, soy " + row["Nombre"] : "Ficha de identificación";
    document.getElementById("saludo").innerText = saludo;

    const fotoCampo = Object.entries(row).find(([k]) => k.toLowerCase().includes("foto"));
    let fotoUrl = "";
    if (fotoCampo) {
      const val = fotoCampo[1];
      if (Array.isArray(val) && val[0]?.path) fotoUrl = `https://idgonow.up.railway.app/${val[0].path}`;
      else if (typeof val === "string" && val.startsWith("http")) fotoUrl = val;
    }
    if (fotoUrl) document.getElementById("foto").src = fotoUrl;

    function linea(titulo, valor) {
      return valor ? `<p><strong>${titulo}:</strong> ${valor}</p>` : "";
    }

    const info = document.getElementById("infoCentral");
    info.innerHTML =
      linea("Edad", row["Edad"]) +
      linea("Tipo", row["Tipo de mascota"]) +
      linea("Raza", row["Raza y características"]) +
      linea("Información médica o datos útiles", row["Información médica o datos útiles"]);

    const contacto = document.getElementById("datosContacto");
    contacto.innerHTML =
      linea("Nombre", row["Nombre del contacto"]) +
      linea("Teléfono", row["Teléfono de contacto"]) +
      linea("Correo", row["Correo de contacto"]);

    const nombre = row["Nombre"] || "la persona o mascota";
    const tel = row["Teléfono de contacto"]?.replace(/\\D/g, "");
    const mensaje = encodeURIComponent(`Hola, he encontrado a ${nombre}, por favor comuníquese conmigo.`);

    if (tel) {
      document.getElementById("botones").innerHTML = `
        <a href="tel:+51${tel}" class="call">📞 Llamar</a>
        <a href="https://wa.me/51${tel}?text=${mensaje}" class="whatsapp" target="_blank">💬 WhatsApp</a>
        <a href="javascript:void(0)" onclick="enviarUbicacion('${tel}', '${nombre}')" class="ubicacion">📍 Enviar ubicación</a>
      `;
    }
  });

  function enviarUbicacion(tel, nombre) {
    if (!navigator.geolocation) return alert("Este navegador no soporta geolocalización.");
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      ubicacionActual = { lat: latitude, lng: longitude, tel, nombre };
      document.getElementById("mapaUbicacion").src = `https://maps.google.com/maps?q=${latitude},${longitude}&hl=es&z=16&output=embed`;
      document.getElementById("ubicacionModal").style.display = "flex";
    }, () => {
      alert("No se pudo obtener la ubicación.");
    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
  }

  function enviarAWhatsApp() {
    const { lat, lng, tel, nombre } = ubicacionActual;
    const mapsLink = `https://www.google.com/maps?q=${lat},${lng}`;
    const msg = `Hola, he encontrado a ${nombre}. Mi ubicación es: ${mapsLink}`;
    window.open(`https://wa.me/51${tel}?text=${encodeURIComponent(msg)}`, '_blank');
    cerrarModal();
  }

  function cerrarModal() {
    document.getElementById("ubicacionModal").style.display = "none";
  }
</script>
</body>
</html>
