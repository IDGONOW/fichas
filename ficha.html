<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IDGoNow | Ficha</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; margin: 0; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
    .container { background: #fff; padding: 1.5rem; border-radius: 12px; max-width: 440px; width: 100%; box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
    .logo { text-align: center; }
    .logo img { width: 140px; margin-bottom: 0.5rem; }
    #foto { width: 192px; height: 192px; object-fit: cover; border-radius: 50%; margin: 0 auto 1rem; display: block; }
    #titulo { text-align: center; font-size: 1.4rem; font-weight: bold; margin: 0.2rem 0 1rem; }
    #infoCentral, #datosContacto { margin-bottom: 1rem; }
    .btns { display: flex; flex-direction: column; gap: 0.7rem; }
    .btns a { text-decoration: none; text-align: center; padding: 0.9rem; border-radius: 8px; font-weight: bold; color: white; font-size: 16px; }
    .call { background-color: #1a73e8; }
    .whatsapp { background-color: #25d366; }
    .ubicacion { background-color: #fbbc05; color: #222; }
    #ubicacionModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0008; z-index: 999; align-items: center; justify-content: center; }
    #ubicacionModal .modal-content { background: white; padding: 1rem; border-radius: 8px; max-width: 320px; width: 90%; }
    #ubicacionModal iframe { width: 100%; height: 200px; border: none; border-radius: 8px; margin-bottom: 1rem; }
    #ubicacionModal .confirm { background: #25d366; color: white; }
    #ubicacionModal .cancel { background: #ccc; margin-left: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo"><img src="logo.png" alt="Logo"></div>
    <img id="foto" src="" alt="Foto">
    <div id="titulo">Cargando ficha‚Ä¶</div>
    <div id="infoCentral"></div>
    <div id="datosContacto"></div>
    <div id="botones" class="btns"></div>
  </div>

  <div id="ubicacionModal">
    <div class="modal-content">
      <h3>Confirmar ubicaci√≥n</h3>
      <p>¬øEsta es tu ubicaci√≥n actual?</p>
      <iframe id="mapaUbicacion" allowfullscreen></iframe>
      <div style="margin-top:1rem; display:flex; justify-content:space-between;">
        <button class="confirm" onclick="confirmarUbicacion()">Enviar</button>
        <button class="cancel" onclick="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    (async () => {
      const params = new URLSearchParams(window.location.search);
      const tag = params.get("tag");
      const idParam = params.get("id");
      let API_URL;
      if (tag) {
        // Filtrar por tag
        API_URL = `https://idgonow.up.railway.app/api/v2/tables/m340oj04ihz4wlu/records?where=${encodeURIComponent(`(tag,eq,${tag})`)}`;
      } else if (idParam) {
        // Buscar por ID
        API_URL = `https://idgonow.up.railway.app/api/v2/tables/m340oj04ihz4wlu/records/${idParam}`;
      } else {
        document.getElementById("titulo").innerText = "Error: no se proporcion√≥ 'id' o 'tag'.";
        return;
      }

      const API_TOKEN = "HzyX5A2ycuqlDhV2uyiQ-12UhN_DM0uO4Bfxe7hy";
      try {
        const res = await fetch(API_URL, { headers: { "xc-token": API_TOKEN } });
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        const data = await res.json();
        let row;

        if (tag) {
          // API devuelve { list: [...] }
          if (Array.isArray(data.list) && data.list.length > 0) {
            row = data.list[0].fields;
          } else {
            document.getElementById("titulo").innerText = `‚ùå No se encontr√≥ ficha para el tag "${tag}".`;
            return;
          }
        } else {
          // API devuelve objeto con .fields
          row = data.fields || data;
        }

        // Mostrar datos
        document.getElementById("titulo").innerText = "Hola, soy " + (row["Nombre"] || "");

        // Foto
        const fotoEntry = Object.entries(row).find(([k]) => k.toLowerCase().includes("foto"));
        if (fotoEntry) {
          const val = fotoEntry[1];
          const path = Array.isArray(val) && val[0]?.path ? val[0].path : (typeof val === "string" && val.startsWith("http") ? val : null);
          if (path) document.getElementById("foto").src = `https://idgonow.up.railway.app/${path}`;
        }

        // L√≠neas de info
        function agregarLinea(titulo, valor, cont) { if (valor) cont.innerHTML += `<p><strong>${titulo}:</strong> ${valor}</p>`; }
        agregarLinea("Edad", row["Edad"], document.getElementById("infoCentral"));
        agregarLinea("Tipo", row["Tipo de mascota"], document.getElementById("infoCentral"));
        agregarLinea("Raza", row["Raza y caracter√≠sticas"], document.getElementById("infoCentral"));
        agregarLinea("Informaci√≥n m√©dica o datos √∫tiles", row["Informaci√≥n m√©dica o datos √∫tiles"], document.getElementById("infoCentral"));
        agregarLinea("Nombre", row["Nombre del contacto"], document.getElementById("datosContacto"));
        agregarLinea("Tel√©fono", row["Tel√©fono de contacto"], document.getElementById("datosContacto"));
        agregarLinea("Correo", row["Correo de contacto"], document.getElementById("datosContacto"));

        // Botones de llamada, WhatsApp y ubicaci√≥n
        const tel = row["Tel√©fono de contacto"]?.replace(/\D/g, "");
        const nombre = row["Nombre"] || "persona o mascota";
        if (tel) {
          const msg = encodeURIComponent(`Hola, he encontrado a ${nombre}, por favor comun√≠quese conmigo.`);
          document.getElementById("botones").innerHTML = `
            <a href="tel:+51${tel}" class="call">üìû Llamar</a>
            <a href="https://wa.me/51${tel}?text=${msg}" target="_blank" class="whatsapp">üí¨ WhatsApp</a>
            <a href="javascript:void(0)" onclick="enviarUbicacion('${tel}', '${nombre}')" class="ubicacion">üìç Enviar ubicaci√≥n</a>
          `;
        }
      } catch (err) {
        document.getElementById("titulo").innerText = "Error al consultar la API: " + err.message;
      }
    })();

    // Funci√≥n de geolocalizaci√≥n
    let ubicacionTmp = {};
    function enviarUbicacion(tel, nombre) {
      if (!navigator.geolocation) { alert("Este navegador no soporta geolocalizaci√≥n."); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        ubicacionTmp = { lat: pos.coords.latitude, lng: pos.coords.longitude, tel, nombre };
        document.getElementById("mapaUbicacion").src = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}&hl=es&z=16&output=embed`;
        document.getElementById("ubicacionModal").style.display = "flex";
      }, () => alert("No se pudo obtener la ubicaci√≥n."), { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    }
    function confirmarUbicacion() {
      const { lat, lng, tel, nombre } = ubicacionTmp;
      const link = `https://www.google.com/maps?q=${lat},${lng}`;
      const msg = `Hola, he encontrado a ${nombre}. Mi ubicaci√≥n actual es: ${link}`;
      window.open(`https://wa.me/51${tel}?text=${encodeURIComponent(msg)}`, '_blank');
      cerrarModal();
    }
    function cerrarModal() { document.getElementById("ubicacionModal").style.display = "none"; }
  </script>
</body>
</html>
